const upload1=require('../model/saveimage')
const ImageModel=require('../model/image.model')
const {spawn}=require('child_process');

const home=(req,res)=>{
    res.render("Homepage");
}

const uploadPage=(req,res)=>{
    res.render("index");
}

const About=(req,res)=>{
    res.render("about");
}

let result;
function func(fname){
    const childpython =spawn('python',['python.py',fname])
    childpython.stdout.on('data',(data)=>{
        result=data.toString();
        console.log( `stdout: ${data}`);
    }),
    childpython.stderr.on('data',(data)=>{
        console.error( `stderr: ${data}`)
    }) 
}

const upload=(req,res)=>{
    upload1(req,res,(err)=>{
        if(err){
            console.log(err);
        }
        else{
            const newImage = new ImageModel({
                name:req.file.filename,
                image:{
                    data:req.file.filename,
                    contentType:'image/png'
                }
            })
            newImage.save()
            .then(()=>console.log('uploaded in mongo')).then(func(req.file.filename)).catch(err=>console.log(err,"failed"));
        }
    })
    setTimeout(()=>{
        if(result===undefined){
            res.send('error')
        }
        else{
            const arr=result.split(' ');
            res.render('output',{label:arr[0],category:arr[1]})
        }
        
    },15000)
}

module.exports={
    home,uploadPage,About,upload
}